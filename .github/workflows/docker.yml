name: "Build Docker images"
on:
  push:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      packages: write

    if: github.repository == 'u1f408/x'
    steps:
    - uses: docker/login-action@v1
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - uses: actions/checkout@v3
    - uses: docker/setup-buildx-action@v1

    - run: |
        BRANCH_NAME=`echo "${GITHUB_REF#refs/heads/}" | sed 's|[^A-Za-z0-9_-]|_|g'`
        BUILD_VERSION=git.`git rev-parse --short HEAD`
        for var in BRANCH_NAME BUILD_VERSION; do
          echo "${var}=${!var}" >> $GITHUB_ENV
        done

    - uses: docker/build-push-action@v2
      with:
        context: .
        file: docker/Dockerfile.go
        push: false
        cache-from: type=registry,ref=ghcr.io/u1f408/docker-cache:x-go
        cache-to: type=registry,ref=ghcr.io/u1f408/docker-cache:x-go,mode=max
        outputs: .docker-bin

    - run: |
        for binary in "uppy"; do
          for tag in latest ${{ env.BRANCH_NAME }} ${{ github.sha }}; do
            cat docker/Dockerfile.bin | sed "s/__BINARY__/$binary/g" | docker build -t ghcr.io/u1f408/$binary:$tag -f - .
          done
          if [ "${{ github.repository }}" == "u1f408/x" ]; then
            docker push ghcr.io/u1f408/$binary:${{ env.BRANCH_NAME }}
            docker push ghcr.io/u1f408/$binary:${{ github.sha }}
            [ "${{ env.BRANCH_NAME }}" == "main" ] && docker push ghcr.io/u1f408/$binary:latest
          fi
        done
